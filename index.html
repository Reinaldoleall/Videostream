<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Streamer Real-Time</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        :root {
            --primary: #0984e3;
            --secondary: #74b9ff;
            --bg: #2d3436;
            --surface: #1e272e;
            --text: #dfe6e9;
            --accent: #00cec9;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }

        body {
            background-color: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- UI MODES --- */
        #mode-selection, #host-view, #remote-view {
            width: 100%; height: 100%;
            display: none; /* Controlado via JS */
        }

        /* --- SELE√á√ÉO --- */
        #mode-selection {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }
        
        .btn-lg {
            background: var(--surface);
            border: 2px solid var(--primary);
            color: white;
            padding: 25px 40px;
            border-radius: 15px;
            font-size: 1.3rem;
            cursor: pointer;
            width: 90%; max-width: 350px;
            display: flex; align-items: center; justify-content: center; gap: 15px;
            transition: 0.2s;
        }
        .btn-lg:hover { background: var(--primary); }

        /* --- HOST UI --- */
        #host-view { flex-direction: column; background: black; }
        
        .video-wrapper {
            flex: 1; display: flex; align-items: center; justify-content: center; position: relative;
        }
        
        video { width: 100%; height: 100%; max-height: 100vh; }

        .overlay-info {
            position: absolute;
            background: rgba(0,0,0,0.85);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid var(--accent);
            text-align: center;
            z-index: 10;
        }
        
        .id-display { font-size: 3rem; color: var(--accent); font-weight: bold; letter-spacing: 5px; margin: 15px 0; }
        
        .buffer-indicator {
            position: absolute; top: 20px; right: 20px;
            background: rgba(0,0,0,0.6); padding: 5px 10px;
            border-radius: 5px; font-size: 0.8rem;
            display: none;
        }

        /* --- REMOTE UI --- */
        #remote-view { flex-direction: column; padding: 20px; background: var(--surface); }

        .input-box {
            background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px;
        }
        
        input[type="text"] {
            width: 100%; padding: 15px; font-size: 1.5rem; text-align: center;
            background: #111; border: 1px solid #444; color: white; border-radius: 5px; margin-bottom: 10px;
            text-transform: uppercase;
        }

        .action-btn {
            width: 100%; padding: 15px; background: var(--primary); border: none;
            color: white; font-weight: bold; font-size: 1.1rem; border-radius: 5px; cursor: pointer;
        }

        .file-select-area {
            border: 2px dashed #555; padding: 40px; text-align: center;
            border-radius: 10px; margin-top: 20px; cursor: pointer;
        }
        
        .status-log {
            margin-top: 15px; font-size: 0.9rem; color: #aaa; text-align: center; font-family: monospace;
        }

        .controls-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: auto;
        }
        .ctrl-btn {
            background: #333; border: none; color: white; padding: 20px; border-radius: 8px; font-size: 1.2rem;
        }
        .ctrl-btn:active { background: var(--primary); }

    </style>
</head>
<body>

    <!-- 1. TELA INICIAL -->
    <div id="mode-selection">
        <h1 style="color: var(--accent); margin-bottom: 20px;">‚ö° Turbo Stream P2P</h1>
        <button class="btn-lg" onclick="initHost()">
            <i class="fas fa-desktop"></i> RECEBER (TV)
        </button>
        <button class="btn-lg" onclick="initRemote()">
            <i class="fas fa-mobile-alt"></i> ENVIAR (Celular)
        </button>
    </div>

    <!-- 2. TELA DA TV (HOST) -->
    <div id="host-view">
        <div class="video-wrapper">
            <video id="video-player" controls autoplay></video>
            
            <div class="overlay-info" id="waiting-overlay">
                <h2>Pronto para Receber</h2>
                <div id="qrcode" style="margin: 20px auto; width: fit-content; background: white; padding: 10px;"></div>
                <p>C√≥digo de Conex√£o:</p>
                <div class="id-display" id="host-id">...</div>
                <p><small>Aguardando conex√£o do celular...</small></p>
            </div>

            <div class="buffer-indicator" id="buffer-stat">Buffer: 0s</div>
        </div>
    </div>

    <!-- 3. TELA DO CELULAR (REMOTE) -->
    <div id="remote-view">
        <h2 style="text-align: center; margin-bottom: 20px;">Controle Remoto</h2>

        <!-- Conex√£o -->
        <div id="step-connect" class="input-box">
            <input type="text" id="remote-code" placeholder="C√ìDIGO" maxlength="4">
            <button class="action-btn" onclick="connectToHost()">CONECTAR</button>
        </div>

        <!-- Envio de Arquivo -->
        <div id="step-upload" style="display: none;">
            <div class="status-log" id="connection-status">üü¢ Conectado!</div>
            
            <label class="file-select-area">
                <i class="fas fa-film" style="font-size: 3rem; color: var(--secondary);"></i>
                <div style="margin-top: 10px;">Toque para selecionar v√≠deo</div>
                <input type="file" id="file-input" accept="video/*" style="display: none;">
            </label>

            <div class="status-log" id="stream-log" style="color: var(--accent);">Aguardando arquivo...</div>
            
            <div class="controls-grid">
                <button class="ctrl-btn" onclick="sendCmd('rewind')"><i class="fas fa-backward"></i></button>
                <button class="ctrl-btn" onclick="sendCmd('play')"><i class="fas fa-play"></i></button>
                <button class="ctrl-btn" onclick="sendCmd('pause')"><i class="fas fa-pause"></i></button>
                <button class="ctrl-btn" onclick="sendCmd('forward')"><i class="fas fa-forward"></i></button>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTES ---
        const CHUNK_SIZE = 64 * 1024; // 64KB (Chunks menores = streaming mais fluido)
        const BUFFER_THRESHOLD = 30;  // TV pede pausa no envio se tiver 30s de v√≠deo bufferizado

        // --- GLOBAIS ---
        let peer, conn;
        let fileReader;
        let isStreaming = false;

        // --- ELEMENTOS ---
        const views = {
            select: document.getElementById('mode-selection'),
            host: document.getElementById('host-view'),
            remote: document.getElementById('remote-view')
        };

        // --- UTILIT√ÅRIOS ---
        function showView(name) {
            Object.values(views).forEach(el => el.style.display = 'none');
            views[name].style.display = 'flex';
        }

        function generateId() {
            return Math.random().toString(36).substring(2, 6).toUpperCase();
        }

        // =================================================================
        // L√ìGICA DO HOST (TV / PC) - O RECEPTOR
        // =================================================================
        let mediaSource;
        let sourceBuffer;
        let queue = [];
        let isAppending = false;

        function initHost() {
            showView('host');
            const myId = generateId();
            document.getElementById('host-id').textContent = myId;
            
            new QRCode(document.getElementById("qrcode"), { text: myId, width: 128, height: 128 });

            peer = new Peer(myId);
            
            peer.on('open', () => console.log('Host ID:', myId));
            
            peer.on('connection', (c) => {
                conn = c;
                document.getElementById('waiting-overlay').innerHTML = `<h3><i class="fas fa-link"></i> Conectado!</h3>`;
                setTimeout(() => document.getElementById('waiting-overlay').style.display = 'none', 1000);
                setupHostEvents();
            });
        }

        function setupHostEvents() {
            const video = document.getElementById('video-player');
            const bufferStat = document.getElementById('buffer-stat');
            bufferStat.style.display = 'block';

            // Monitorar Buffer
            setInterval(() => {
                if(video.buffered.length > 0) {
                    const end = video.buffered.end(video.buffered.length - 1);
                    const current = video.currentTime;
                    const bufferSize = end - current;
                    bufferStat.textContent = `Buffer: ${bufferSize.toFixed(1)}s`;

                    // BACKPRESSURE: Se temos muito buffer, avisa o sender para esperar
                    if (bufferSize > BUFFER_THRESHOLD) {
                        conn.send({ type: 'BUSY' });
                    } else {
                        conn.send({ type: 'READY' });
                    }
                }
            }, 1000);

            conn.on('data', (data) => {
                if (data.type === 'meta') {
                    // Inicializar Media Source
                    startMediaSource(data.mime);
                } 
                else if (data.type === 'chunk') {
                    handleChunk(data.payload);
                }
                else if (data.type === 'cmd') {
                    handleCommand(data.action);
                }
            });
        }

        function startMediaSource(mimeType) {
            const video = document.getElementById('video-player');
            
            if (!MediaSource.isTypeSupported(mimeType)) {
                // Fallback gen√©rico se o codec exato n√£o for suportado
                console.warn("Mime type exato n√£o suportado, tentando gen√©rico mp4");
                mimeType = 'video/mp4; codecs="avc1.42E01E, mp4a.40.2"'; 
            }

            mediaSource = new MediaSource();
            video.src = URL.createObjectURL(mediaSource);

            mediaSource.addEventListener('sourceopen', () => {
                try {
                    sourceBuffer = mediaSource.addSourceBuffer(mimeType);
                    sourceBuffer.addEventListener('updateend', processQueue);
                    // Avisa o sender para come√ßar a enviar
                    conn.send({ type: 'READY' });
                } catch (e) {
                    alert("Erro de Codec: O navegador da TV n√£o suporta este formato de v√≠deo.");
                    console.error(e);
                }
            });
        }

        function handleChunk(arrayBuffer) {
            queue.push(arrayBuffer);
            processQueue();
        }

        function processQueue() {
            if (sourceBuffer && !sourceBuffer.updating && queue.length > 0) {
                try {
                    const chunk = queue.shift();
                    sourceBuffer.appendBuffer(chunk);
                } catch (e) {
                    console.error("Erro no appendBuffer:", e);
                }
            }
        }

        function handleCommand(action) {
            const v = document.getElementById('video-player');
            switch(action) {
                case 'play': v.play(); break;
                case 'pause': v.pause(); break;
                case 'forward': v.currentTime += 10; break;
                case 'rewind': v.currentTime -= 10; break;
            }
        }

        // =================================================================
        // L√ìGICA DO REMOTE (CELULAR) - O EMISSOR
        // =================================================================
        let fileToSend = null;
        let offset = 0;
        let isPausedByHost = false;

        function initRemote() {
            showView('remote');
            peer = new Peer(); // ID autom√°tico
        }

        function connectToHost() {
            const code = document.getElementById('remote-code').value.toUpperCase();
            if(!code) return alert("Digite o c√≥digo");

            const btn = document.querySelector('#step-connect button');
            btn.textContent = "Conectando...";
            
            conn = peer.connect(code);
            
            conn.on('open', () => {
                document.getElementById('step-connect').style.display = 'none';
                document.getElementById('step-upload').style.display = 'block';
            });

            conn.on('error', (err) => {
                alert("Erro ao conectar.");
                btn.textContent = "CONECTAR";
            });

            // Controle de Fluxo (Backpressure)
            conn.on('data', (data) => {
                if (data.type === 'READY') {
                    if (isPausedByHost) {
                        isPausedByHost = false;
                        document.getElementById('stream-log').textContent = "Enviando...";
                        readNextChunk(); // Retoma envio
                    }
                    if (!isStreaming && fileToSend) {
                        // In√≠cio da transmiss√£o
                        isStreaming = true;
                        readNextChunk();
                    }
                } 
                else if (data.type === 'BUSY') {
                    isPausedByHost = true;
                    document.getElementById('stream-log').textContent = "Buffer cheio (Aguardando TV...)";
                }
            });
        }

        // Input de Arquivo
        document.getElementById('file-input').addEventListener('change', (e) => {
            fileToSend = e.target.files[0];
            if(!fileToSend) return;

            offset = 0;
            isStreaming = false;
            isPausedByHost = false;
            
            document.getElementById('stream-log').textContent = `Iniciando: ${fileToSend.name}`;
            
            // Tenta detectar mime type completo ou usa padr√£o seguro
            const mime = fileToSend.type || 'video/mp4; codecs="avc1.42E01E, mp4a.40.2"';

            conn.send({ type: 'meta', mime: mime, size: fileToSend.size });
            // O envio real come√ßa quando recebermos 'READY' da TV
        });

        function readNextChunk() {
            if (isPausedByHost || !fileToSend) return;
            if (offset >= fileToSend.size) {
                document.getElementById('stream-log').textContent = "Envio Completo!";
                return;
            }

            const reader = new FileReader();
            const slice = fileToSend.slice(offset, offset + CHUNK_SIZE);

            reader.onload = (e) => {
                if (conn.open) {
                    conn.send({
                        type: 'chunk',
                        payload: e.target.result
                    });
                    
                    offset += CHUNK_SIZE;
                    
                    // Mostra progresso
                    const pct = Math.round((offset / fileToSend.size) * 100);
                    document.getElementById('stream-log').textContent = `Enviando: ${pct}%`;

                    // Loop de leitura (pequeno delay para n√£o travar a UI do celular)
                    setTimeout(readNextChunk, 5); 
                }
            };
            
            reader.readAsArrayBuffer(slice);
        }

        function sendCmd(action) {
            if(conn && conn.open) conn.send({ type: 'cmd', action: action });
        }
    </script>
</body>
</html>


